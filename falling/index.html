<html>
	<head>
		<script src="pixi-legacy.min.js"></script>
		<style>
			* {
				margin: 0;
				background: none;
				overflow: hidden;
			}
			html {
				background-color:  darkred;
			}
			html:not(:hover), body:not(:hover){
    			background-color: black;
			}
		</style>
	</head>
	<body>
		<script>
			window.onload = function() {
				
				var keys = {};
				window.addEventListener( "keydown", evemt => {
					keys[ event.keyCode ] = true;
				});
				window.addEventListener( "keyup", event => {
					keys[ event.keyCode ] = false;
				});

				function handleOrientation( event ) {
					scale = 2 - Math.round( event.beta || 0 ) / 100;
				}
				function handleMove( event ) {
					scale = 2- Math.round( event.clientX - ( window.innerWidth / 2 ) ) / 100;
				}
				function devOr() {
					if ( typeof DeviceOrientationEvent === 'function' ) { 
						if ( typeof DeviceOrientationEvent.requestPermission === 'function' ) {
							DeviceOrientationEvent.requestPermission().then( response => {
								if ( response == 'granted' ) window.addEventListener( 'deviceorientation', handleOrientation )
							}).catch( console.error )
						} else window.addEventListener( 'deviceorientation', handleOrientation );
					}
				}
				//window.addEventListener( 'mousemove', handleMove );
				//devOr();


				async function init() {
					// manifest example
					const manifest = {
						bundles: [{
								name: 'ozora-stage',
								assets: [
									{
										alias: 'back1',
										src: 'assets/B01.png',
									},
									{
										alias: 'back2',
										src: 'assets/B02.png',
									},
									{
										alias: 'back3',
										src: 'assets/B02.png',
									},
									{
										alias: 'mid1',
										src: 'assets/B01.png',
									},
									{
										alias: 'mid2',
										src: 'assets/B02.png',
									},
									{
										alias: 'mid3',
										src: 'assets/B03.png',
									},
									{
										alias: 'mid4',
										src: 'assets/B03.png',
									},
									{
										alias: 'mid5',
										src: 'assets/B05.png',
									},
									{
										alias: 'mid6',
										src: 'assets/B06.png',
									},
									{
										alias: 'front1',
										src: 'assets/B01.png',
									},
									{
										alias: 'front2',
										src: 'assets/B02.png',
									},
									{
										alias: 'front3',
										src: 'assets/B03.png',
									},
									{
										alias: 'front4',
										src: 'assets/B03.png',
									},
									{
										alias: 'front5',
										src: 'assets/B05.png',
									},
									{
										alias: 'front6',
										src: 'assets/B06.png',
									},
									{
										alias: 'front7',
										src: 'assets/B07.png',
									},
									{
										alias: 'front8',
										src: 'assets/B08.png',
									},
									{
										alias: 'front9',
										src: 'assets/B09.png',
									},
								],
							},
						]
					};

					await PIXI.Assets.init({ manifest });
					PIXI.Assets.backgroundLoadBundle([
						'ozora-satage'
					]);
				}
				
				async function loadScreen( place )
{
					const loadScreenAssets = await PIXI.Assets.loadBundle( place );
					for ( let i = 1; i < 4; i++ ) {
						const goNext = new PIXI.Sprite( loadScreenAssets[ 'back' + i ] );
						goNext.width = app.screen.width;
						goNext.heigt = app.screen.width;
						back.addChild( goNext );
					}
					for ( let i = 1; i < 7; i++ ) {
						const goNext = new PIXI.Sprite( loadScreenAssets[ 'mid' + i ] );
						goNext.width = app.screen.width;
						goNext.heigt = app.screen.width;
						mid.addChild( goNext );
					}
					for ( let i = 1; i < 10; i++ ) {
						const goNext = new PIXI.Sprite( loadScreenAssets[ 'front' + i ] );
						goNext.width = app.screen.width;
						goNext.heigt = app.screen.width;
						front.addChild( goNext );
					}

				}

				init();
				loadScreen( 'ozora-stage' );
				
				const app = new PIXI.Application({ 
					background: 'darkred', 
					resizeTo: window 
				});
				
				const back = new PIXI.Container();
				const mid = new PIXI.Container();
				const front = new PIXI.Container();

				const floating = [];
				const falling = [];
				var animation = floating;
				var animationSpeed = 0.3;
				var scale = 1;
				var scaleSpeed = 0.01;
				var isFalling= false;

				PIXI.Assets.load( 'falling.json' ).then( () => {

					back.x = 0;
					back.y = 0;
					back.name = 'back';
					back.width = app.screen.width;

					mid.x = 0;
					mid.y = 0;
					mid.name = 'mid';
					mid.width = app.screen.width;

					front.x = 0;
					front.y = 0;
					front.name = 'front';
					front.width = app.screen.width;


					for ( let i = 0; i < 45; i++)  {
						const val = i < 10 ? `0${ i }` : i;
						
						const backSprite = new PIXI.Sprite( PIXI.Texture.from( `assets/FALL-${ val }.png` ) );
						backSprite.y = i * 480;
						backSprite.x = 0;
						backSprite.width = app.screen.width;
						back.addChild( backSprite );
						
						falling.push( PIXI.Texture.from( `assets/FALL-${ val }.png` ) );
						floating.push( PIXI.Texture.from( `assets/FLOAT-${ val }.png` ) );
					}

					const figure = new PIXI.AnimatedSprite( animation );
					figure.x = app.screen.width / 2;
					figure.y = app.screen.height / 2;
					figure.name = 'figure';
					figure.anchor.set( 0.5 );
					figure.animationSpeed = animationSpeed;
					figure.loop = false;
					figure.play();

					app.stage.addChild( back );
					app.stage.addChild( mid );
					app.stage.addChild( figure );
					app.stage.addChild( front );

					app.ticker.add( () => {
						if ( keys[ "40" ] ) {
							if ( !isFalling ) figure.animationSpeed = 1.2;
							scale = 0.5;
							animation = falling;
							animationSpeed = 0.3;
console.log( back.height );
						}
						if ( !figure.playing  ) {
							figure.textures = animation;
							isFalling = ( figure.textures == falling ) ? true : false;
							if ( !isFalling ) scale = 1;
							figure.animationSpeed = animationSpeed;
							figure.play();
							animation = floating;
						}
						if ( figure.scale.x > scale ) {
							figure.scale.x -= scaleSpeed;
							figure.scale.y -= scaleSpeed;
						}
						if ( figure.scale.x < scale ) {
							figure.scale.x += scaleSpeed;
							figure.scale.y += scaleSpeed;
						}
					});
				}).catch( console.error );

				document.body.appendChild( app.view );
				window.addEventListener( 'resize', ( event ) => {
					app.renderer.resize( window.innerWidth, window.innerHeight );
					app.stage.children.forEach( function( item, index, object ) {
						if ( item.name == 'figure' ) {
							item.x = app.screen.width * item.anchor.x;
							item.y = app.screen.height * item.anchor.y;
						} else {
							item.y += 10;
						}
					});
				});
			}
		</script>
	</head>
</html>